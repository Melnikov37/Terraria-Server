{% extends "base.html" %}
{% block title %}World — Terraria Admin{% endblock %}

{% block content %}
<div class="page-header">
    <div style="display:flex;align-items:baseline;gap:14px;flex-wrap:wrap;">
        <h2 style="margin:0;">World Controls</h2>
        {% if status.port %}
        <span style="font-size:0.82rem;color:var(--text-muted);font-family:var(--font-mono);">
            port <strong style="color:var(--text-dim);">{{ status.port }}</strong>
        </span>
        {% endif %}
        {% if status.world and status.world != 'Unknown' %}
        <span style="font-size:0.82rem;color:var(--text-muted);">
            world: <strong style="color:var(--text-dim);">{{ status.world }}</strong>
        </span>
        {% endif %}
    </div>
    {% if status.online and status.server_type == 'tshock' %}
    <form method="POST" action="{{ url_for('world.save_world') }}" class="inline-form">
        <button type="submit" class="btn btn-success">Save World</button>
    </form>
    {% endif %}
</div>

<!-- Worlds list -->
<div class="card">
    <div class="card-title" style="display:flex;align-items:center;justify-content:space-between;">
        <span>Worlds</span>
        <span style="font-weight:400;font-size:0.85rem;color:var(--text-muted);">
            {{ worlds|length }} world{{ 's' if worlds|length != 1 else '' }}
        </span>
    </div>
    {% if worlds %}
    <div style="display:flex;flex-direction:column;gap:8px;">
        {% for w in worlds %}
        {% set is_active = (w.name == status.world) %}
        <div style="display:flex;align-items:center;gap:14px;padding:12px 16px;
                    border-radius:var(--radius-md);
                    background:{% if is_active %}var(--bg-elevated){% else %}var(--bg){% endif %};
                    border:1px solid {% if is_active %}var(--success){% else %}var(--border){% endif %};">
            <div style="flex:1;min-width:0;">
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:3px;">
                    <strong style="font-size:1rem;">{{ w.name }}</strong>
                    {% if is_active %}
                    <span style="font-size:0.7rem;font-weight:700;padding:2px 8px;
                                 border-radius:20px;background:var(--success-bg);
                                 color:var(--success);letter-spacing:0.06em;text-transform:uppercase;">
                        Active
                    </span>
                    {% endif %}
                </div>
                <div style="color:var(--text-muted);font-size:0.82rem;">
                    {{ w.size_mb }} MB &middot; modified {{ w.modified }}
                </div>
            </div>
            {% if not is_active %}
            <form method="POST" action="{{ url_for('world.world_switch') }}" class="inline-form">
                <input type="hidden" name="world_name" value="{{ w.name }}">
                <button type="submit" class="btn btn-primary"
                        style="height:34px;font-size:0.85rem;padding:0 14px;"
                        onclick="return confirm('Switch to this world and restart the server?');">
                    Switch &amp; Restart
                </button>
            </form>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% elif generating %}
    <meta http-equiv="refresh" content="15">
    <div style="display:flex;align-items:center;gap:14px;padding:16px;
                border-radius:var(--radius-md);background:var(--bg);
                border:1px solid var(--warning);">
        <span style="font-size:1.3rem;animation:spin 1.2s linear infinite;display:inline-block;">↻</span>
        <div>
            <strong style="font-size:1rem;color:var(--warning);">Generating "{{ generating }}"…</strong>
            <div style="color:var(--text-muted);font-size:0.82rem;margin-top:3px;">
                World generation takes 2–5 minutes. Page refreshes automatically.
                Watch progress in <a href="{{ url_for('console.console') }}" style="color:var(--accent);">Console</a>.
            </div>
        </div>
    </div>
    {% else %}
    <p style="color:var(--text-muted);text-align:center;padding:24px 0;margin:0;">
        No world files found. Create a new world below.
    </p>
    {% endif %}
</div>

<!-- New World Creation -->
<div class="card">
    <div class="card-title">Create New World</div>
    <form method="POST" action="{{ url_for('world.recreate_world') }}"
          onsubmit="return confirm('Create new world and restart the server?');">

        <div class="grid grid-3">
            <div class="form-group">
                <label>World Name</label>
                <input type="text" name="worldname" value="World" required
                       maxlength="64" pattern="[^/\\\\.]+" title="No slashes or dots"
                       autocomplete="off">
            </div>
            <div class="form-group">
                <label>Size</label>
                <select name="size">
                    <option value="1">Small (4200 × 1200)</option>
                    <option value="2" selected>Medium (6400 × 1800)</option>
                    <option value="3">Large (8400 × 2400)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Difficulty</label>
                <select name="difficulty">
                    <option value="0">Classic</option>
                    <option value="1">Expert</option>
                    <option value="2">Master</option>
                    <option value="3">Journey</option>
                </select>
            </div>
            <div class="form-group">
                <label>Evil Type</label>
                <select name="evil">
                    <option value="0">Random</option>
                    <option value="1">Corruption</option>
                    <option value="2">Crimson</option>
                </select>
            </div>
            <div class="form-group" style="grid-column: span 2;">
                <label>Seed <span style="color:var(--text-muted); font-weight:400; font-size:0.8rem; text-transform:none; letter-spacing:0;">(leave blank for random)</span></label>
                <input type="text" name="seed" placeholder='e.g. 12345678 or "not the bees"'
                       style="font-family:var(--font-mono);">
            </div>
        </div>
        <div style="display:flex; align-items:center; gap:16px; flex-wrap:wrap;">
            <button type="submit" class="btn btn-primary">Create New World</button>
            <span style="color:var(--text-muted); font-size:0.875rem;">
                Existing worlds are kept — use Switch and Restart to change the active world.
            </span>
        </div>
    </form>
</div>

{% if not status.online %}
<div class="card">
    <p style="color:var(--text-muted);">Server is offline. Start the server to access more controls.</p>
</div>

{% elif status.server_type == 'tmodloader' %}
<div class="grid grid-2">
    <div class="card">
        <div class="card-title">Time Control</div>
        <form method="POST" action="{{ url_for('world.set_time') }}">
            <div class="form-group">
                <label>Set Time</label>
                <select name="time">
                    <option value="day">Dawn</option>
                    <option value="noon">Noon</option>
                    <option value="night">Dusk</option>
                    <option value="midnight">Midnight</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">Set Time</button>
        </form>
    </div>

    <div class="card">
        <div class="card-title">Broadcast Message</div>
        <form method="POST" action="{{ url_for('world.broadcast') }}">
            <div class="form-group">
                <label>Message</label>
                <input type="text" name="message" required placeholder="Message to all players">
            </div>
            <button type="submit" class="btn btn-primary">Send</button>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-title">Save World</div>
    <form method="POST" action="{{ url_for('world.save_world') }}">
        <button type="submit" class="btn btn-success">Save World Now</button>
        <span style="color:var(--text-muted); margin-left:14px; font-size:0.875rem;">
            tModLoader also auto-saves periodically
        </span>
    </form>
</div>

<div class="card">
    <div class="card-title">Execute Server Command</div>
    <form method="POST" action="{{ url_for('world.run_command') }}">
        <div class="form-group">
            <label>Command (sent directly to server stdin)</label>
            <input type="text" name="command" required placeholder="e.g. players, save, dawn, kick PlayerName">
            <small style="color:var(--text-muted); display:block; margin-top:5px;">
                Available: dawn, noon, dusk, midnight, save, players, say &lt;msg&gt;, kick &lt;name&gt;, ban &lt;name&gt;, exit
            </small>
        </div>
        <button type="submit" class="btn btn-primary">Execute</button>
    </form>
</div>

{% elif status.server_type == 'tshock' %}
<div class="grid grid-2">
    <div class="card">
        <div class="card-title">Time Control</div>
        <form method="POST" action="{{ url_for('world.set_time') }}">
            <div class="form-group">
                <label>Set Time</label>
                <select name="time">
                    <option value="day">Day (4:30 AM)</option>
                    <option value="noon">Noon (12:00 PM)</option>
                    <option value="night">Night (7:30 PM)</option>
                    <option value="midnight">Midnight (12:00 AM)</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">Set Time</button>
        </form>
    </div>

    <div class="card">
        <div class="card-title">Broadcast Message</div>
        <form method="POST" action="{{ url_for('world.broadcast') }}">
            <div class="form-group">
                <label>Message</label>
                <input type="text" name="message" required placeholder="Message to all players">
            </div>
            <button type="submit" class="btn btn-primary">Send Broadcast</button>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-title">Quick Commands</div>
    <div class="btn-group" style="flex-wrap:wrap;">
        <form method="POST" action="{{ url_for('world.run_command') }}" class="inline-form">
            <input type="hidden" name="command" value="/blood">
            <button type="submit" class="btn btn-danger">Blood Moon</button>
        </form>
        <form method="POST" action="{{ url_for('world.run_command') }}" class="inline-form">
            <input type="hidden" name="command" value="/eclipse">
            <button type="submit" class="btn btn-danger">Solar Eclipse</button>
        </form>
        <form method="POST" action="{{ url_for('world.run_command') }}" class="inline-form">
            <input type="hidden" name="command" value="/invade goblins">
            <button type="submit" class="btn btn-warning">Goblin Invasion</button>
        </form>
        <form method="POST" action="{{ url_for('world.run_command') }}" class="inline-form">
            <input type="hidden" name="command" value="/invade pirates">
            <button type="submit" class="btn btn-warning">Pirate Invasion</button>
        </form>
        <form method="POST" action="{{ url_for('world.run_command') }}" class="inline-form">
            <input type="hidden" name="command" value="/rain">
            <button type="submit" class="btn btn-primary">Toggle Rain</button>
        </form>
        <form method="POST" action="{{ url_for('world.butcher') }}" class="inline-form">
            <button type="submit" class="btn btn-danger">Kill All Mobs</button>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-title">Execute Command</div>
    <form method="POST" action="{{ url_for('world.run_command') }}">
        <div class="form-group">
            <label>TShock Command</label>
            <input type="text" name="command" required placeholder="/command args">
            <small style="color:var(--text-muted); display:block; margin-top:5px;">
                Examples: /time day, /rain, /spawnmob zombie 10, /give playername item
            </small>
        </div>
        <button type="submit" class="btn btn-primary">Execute</button>
    </form>
</div>

<div class="card">
    <div class="card-title">Command Reference</div>
    <table class="table">
        <tr><td><code>/time day|night|noon|midnight</code></td><td>Set world time</td></tr>
        <tr><td><code>/rain</code></td><td>Toggle rain</td></tr>
        <tr><td><code>/blood</code></td><td>Start blood moon</td></tr>
        <tr><td><code>/eclipse</code></td><td>Start solar eclipse</td></tr>
        <tr><td><code>/invade &lt;type&gt;</code></td><td>Start invasion (goblins, pirates, snowmen, pumpkin, frost, martian)</td></tr>
        <tr><td><code>/spawnmob &lt;name&gt; &lt;amount&gt;</code></td><td>Spawn mobs</td></tr>
        <tr><td><code>/spawnboss &lt;name&gt;</code></td><td>Spawn boss (eow, eoc, kingslime, wof, etc.)</td></tr>
        <tr><td><code>/butcher</code></td><td>Kill all hostile NPCs</td></tr>
        <tr><td><code>/give &lt;player&gt; &lt;item&gt; &lt;amount&gt;</code></td><td>Give item to player</td></tr>
        <tr><td><code>/tp &lt;player1&gt; &lt;player2&gt;</code></td><td>Teleport player</td></tr>
    </table>
</div>

{% else %}
<div class="card">
    <div class="card-title">Vanilla Server</div>
    <p style="color:var(--text-muted);">
        Vanilla server is running. In-game commands are not available via web interface.
    </p>
    <p style="color:var(--text-muted); margin-top:10px;">
        Use the "Create New World" form above to reset the world with different settings.
    </p>
</div>
{% endif %}
{% endblock %}
