{% extends "base.html" %}
{% block title %}World — Terraria Admin{% endblock %}

{% block content %}
<div class="page-header">
    <h2>World Controls</h2>
    {% if status.online and status.server_type == 'tshock' %}
    <form method="POST" action="{{ url_for('world.save_world') }}" class="inline-form">
        <button type="submit" class="btn btn-success">Save World</button>
    </form>
    {% endif %}
</div>

<!-- Switch existing world -->
{% if worlds %}
<div class="card">
    <div class="card-title">Switch World</div>
    <p style="color:var(--text-muted); margin-bottom:15px; font-size:0.9rem;">
        Switch to an existing world file. Server will restart automatically.
        Current world: <strong>{{ status.world }}</strong>
    </p>
    <form method="POST" action="{{ url_for('world.world_switch') }}">
        <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;">
            <div class="form-group" style="flex:1; margin-bottom:0;">
                <label>Select World</label>
                <select name="world_name">
                    {% for w in worlds %}
                    <option value="{{ w.name }}" {{ 'selected' if w.name == status.world }}>
                        {{ w.name }} ({{ w.size_mb }} MB, {{ w.modified }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn btn-primary" style="height:42px;"
                    onclick="return confirm('Switch world and restart server?');">
                Switch &amp; Restart
            </button>
        </div>
    </form>
</div>
{% endif %}

<!-- New World Creation -->
<div class="card">
    <div class="card-title">Create New World</div>
    <form method="POST" action="{{ url_for('world.recreate_world') }}"
          onsubmit="return confirm('This will DELETE the current world and create a new one. Old world will be backed up. Continue?');">
        <div class="grid grid-3">
            <div class="form-group">
                <label>World Name</label>
                <input type="text" name="worldname" value="World" required>
            </div>
            <div class="form-group">
                <label>Size</label>
                <select name="size">
                    <option value="1">Small (4200 × 1200)</option>
                    <option value="2" selected>Medium (6400 × 1800)</option>
                    <option value="3">Large (8400 × 2400)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Difficulty</label>
                <select name="difficulty">
                    <option value="0">Classic</option>
                    <option value="1">Expert</option>
                    <option value="2">Master</option>
                    <option value="3">Journey</option>
                </select>
            </div>
            <div class="form-group">
                <label>Evil Type</label>
                <select name="evil">
                    <option value="0">Random</option>
                    <option value="1">Corruption</option>
                    <option value="2">Crimson</option>
                </select>
            </div>
            <div class="form-group" style="grid-column: span 2;">
                <label>Seed <span style="color:var(--text-muted); font-weight:400; font-size:0.8rem; text-transform:none; letter-spacing:0;">(leave blank for random)</span></label>
                <input type="text" name="seed" placeholder='e.g. 12345678 or "not the bees"'
                       style="font-family:var(--font-mono);">
            </div>
        </div>
        <div style="display:flex; align-items:center; gap:16px; flex-wrap:wrap;">
            <button type="submit" class="btn btn-danger">Create New World</button>
            <span style="color:var(--text-muted); font-size:0.875rem;">
                Warning: current world will be backed up and deleted
            </span>
        </div>
    </form>
</div>

{% if not status.online %}
<div class="card">
    <p style="color:var(--text-muted);">Server is offline. Start the server to access more controls.</p>
</div>

{% elif status.server_type == 'tmodloader' %}
<div class="grid grid-2">
    <div class="card">
        <div class="card-title">Time Control</div>
        <form method="POST" action="{{ url_for('world.set_time') }}">
            <div class="form-group">
                <label>Set Time</label>
                <select name="time">
                    <option value="day">Dawn</option>
                    <option value="noon">Noon</option>
                    <option value="night">Dusk</option>
                    <option value="midnight">Midnight</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">Set Time</button>
        </form>
    </div>

    <div class="card">
        <div class="card-title">Broadcast Message</div>
        <form method="POST" action="{{ url_for('world.broadcast') }}">
            <div class="form-group">
                <label>Message</label>
                <input type="text" name="message" required placeholder="Message to all players">
            </div>
            <button type="submit" class="btn btn-primary">Send</button>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-title">Save World</div>
    <form method="POST" action="{{ url_for('world.save_world') }}">
        <button type="submit" class="btn btn-success">Save World Now</button>
        <span style="color:var(--text-muted); margin-left:14px; font-size:0.875rem;">
            tModLoader also auto-saves periodically
        </span>
    </form>
</div>

<div class="card">
    <div class="card-title">Execute Server Command</div>
    <form method="POST" action="{{ url_for('world.run_command') }}">
        <div class="form-group">
            <label>Command (sent directly to server stdin)</label>
            <input type="text" name="command" required placeholder="e.g. players, save, dawn, kick PlayerName">
            <small style="color:var(--text-muted); display:block; margin-top:5px;">
                Available: dawn, noon, dusk, midnight, save, players, say &lt;msg&gt;, kick &lt;name&gt;, ban &lt;name&gt;, exit
            </small>
        </div>
        <button type="submit" class="btn btn-primary">Execute</button>
    </form>
</div>

{% elif status.server_type == 'tshock' %}
<div class="grid grid-2">
    <div class="card">
        <div class="card-title">Time Control</div>
        <form method="POST" action="{{ url_for('world.set_time') }}">
            <div class="form-group">
                <label>Set Time</label>
                <select name="time">
                    <option value="day">Day (4:30 AM)</option>
                    <option value="noon">Noon (12:00 PM)</option>
                    <option value="night">Night (7:30 PM)</option>
                    <option value="midnight">Midnight (12:00 AM)</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">Set Time</button>
        </form>
    </div>

    <div class="card">
        <div class="card-title">Broadcast Message</div>
        <form method="POST" action="{{ url_for('world.broadcast') }}">
            <div class="form-group">
                <label>Message</label>
                <input type="text" name="message" required placeholder="Message to all players">
            </div>
            <button type="submit" class="btn btn-primary">Send Broadcast</button>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-title">Quick Commands</div>
    <div class="btn-group" style="flex-wrap:wrap;">
        <form method="POST" action="{{ url_for('world.run_command') }}" class="inline-form">
            <input type="hidden" name="command" value="/blood">
            <button type="submit" class="btn btn-danger">Blood Moon</button>
        </form>
        <form method="POST" action="{{ url_for('world.run_command') }}" class="inline-form">
            <input type="hidden" name="command" value="/eclipse">
            <button type="submit" class="btn btn-danger">Solar Eclipse</button>
        </form>
        <form method="POST" action="{{ url_for('world.run_command') }}" class="inline-form">
            <input type="hidden" name="command" value="/invade goblins">
            <button type="submit" class="btn btn-warning">Goblin Invasion</button>
        </form>
        <form method="POST" action="{{ url_for('world.run_command') }}" class="inline-form">
            <input type="hidden" name="command" value="/invade pirates">
            <button type="submit" class="btn btn-warning">Pirate Invasion</button>
        </form>
        <form method="POST" action="{{ url_for('world.run_command') }}" class="inline-form">
            <input type="hidden" name="command" value="/rain">
            <button type="submit" class="btn btn-primary">Toggle Rain</button>
        </form>
        <form method="POST" action="{{ url_for('world.butcher') }}" class="inline-form">
            <button type="submit" class="btn btn-danger">Kill All Mobs</button>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-title">Execute Command</div>
    <form method="POST" action="{{ url_for('world.run_command') }}">
        <div class="form-group">
            <label>TShock Command</label>
            <input type="text" name="command" required placeholder="/command args">
            <small style="color:var(--text-muted); display:block; margin-top:5px;">
                Examples: /time day, /rain, /spawnmob zombie 10, /give playername item
            </small>
        </div>
        <button type="submit" class="btn btn-primary">Execute</button>
    </form>
</div>

<div class="card">
    <div class="card-title">Command Reference</div>
    <table class="table">
        <tr><td><code>/time day|night|noon|midnight</code></td><td>Set world time</td></tr>
        <tr><td><code>/rain</code></td><td>Toggle rain</td></tr>
        <tr><td><code>/blood</code></td><td>Start blood moon</td></tr>
        <tr><td><code>/eclipse</code></td><td>Start solar eclipse</td></tr>
        <tr><td><code>/invade &lt;type&gt;</code></td><td>Start invasion (goblins, pirates, snowmen, pumpkin, frost, martian)</td></tr>
        <tr><td><code>/spawnmob &lt;name&gt; &lt;amount&gt;</code></td><td>Spawn mobs</td></tr>
        <tr><td><code>/spawnboss &lt;name&gt;</code></td><td>Spawn boss (eow, eoc, kingslime, wof, etc.)</td></tr>
        <tr><td><code>/butcher</code></td><td>Kill all hostile NPCs</td></tr>
        <tr><td><code>/give &lt;player&gt; &lt;item&gt; &lt;amount&gt;</code></td><td>Give item to player</td></tr>
        <tr><td><code>/tp &lt;player1&gt; &lt;player2&gt;</code></td><td>Teleport player</td></tr>
    </table>
</div>

{% else %}
<div class="card">
    <div class="card-title">Vanilla Server</div>
    <p style="color:var(--text-muted);">
        Vanilla server is running. In-game commands are not available via web interface.
    </p>
    <p style="color:var(--text-muted); margin-top:10px;">
        Use the "Create New World" form above to reset the world with different settings.
    </p>
</div>
{% endif %}
{% endblock %}
