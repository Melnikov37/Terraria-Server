{% extends "base.html" %}
{% block title %}Configuration — Terraria Admin{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Server Configuration</h2>
</div>

{% if is_default_secret %}
<div style="background:var(--warning-bg);border:1px solid var(--warning);border-radius:var(--radius-md);
            padding:12px 16px;margin-bottom:20px;display:flex;align-items:center;gap:10px;">
    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
         style="width:20px;height:20px;color:var(--warning);flex-shrink:0;">
        <path stroke-linecap="round" stroke-linejoin="round"
              d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z"/>
    </svg>
    <span style="color:var(--warning);font-size:0.875rem;">
        <strong>Security warning:</strong> SECRET_KEY is set to the default value.
        Set a strong random key in your <code>.env</code> file: <code>SECRET_KEY=&lt;random 32+ chars&gt;</code>
    </span>
</div>
{% endif %}

<form method="POST" action="{{ url_for('config_bp.save_config') }}">
    <div class="grid grid-2">
        <div class="card">
            <div class="card-title">World Settings</div>

            <div class="form-group">
                <label>World Name</label>
                <input type="text" name="worldname" value="{{ server_config.get('worldname', 'World') }}"
                       pattern="[^/\\&lt;&gt;:\&quot;|?*.]+"
                       title="World name cannot contain / \\ . : &lt; &gt; | ? *"
                       required>
            </div>

            <div class="form-group">
                <label>World Size (for new worlds)</label>
                <select name="autocreate">
                    <option value="1" {{ 'selected' if server_config.get('autocreate') == '1' }}>Small</option>
                    <option value="2" {{ 'selected' if server_config.get('autocreate') == '2' }}>Medium</option>
                    <option value="3" {{ 'selected' if server_config.get('autocreate') == '3' }}>Large</option>
                </select>
            </div>

            <div class="form-group">
                <label>Difficulty</label>
                <select name="difficulty">
                    <option value="0" {{ 'selected' if server_config.get('difficulty') == '0' }}>Classic</option>
                    <option value="1" {{ 'selected' if server_config.get('difficulty') == '1' }}>Expert</option>
                    <option value="2" {{ 'selected' if server_config.get('difficulty') == '2' }}>Master</option>
                    <option value="3" {{ 'selected' if server_config.get('difficulty') == '3' }}>Journey</option>
                </select>
            </div>
        </div>

        <div class="card">
            <div class="card-title">Server Settings</div>

            <div class="form-group">
                <label>Max Players</label>
                <input type="number" name="maxplayers" min="1" max="255"
                       value="{{ server_config.get('maxplayers', '8') }}">
            </div>

            <div class="form-group">
                <label>Port</label>
                <input type="number" name="port" min="1" max="65535"
                       value="{{ server_config.get('port', '7777') }}">
            </div>

            <div class="form-group">
                <label>Password (empty = no password)</label>
                <input type="text" name="password"
                       value="{{ server_config.get('password', '') }}"
                       placeholder="Leave empty for no password">
            </div>

            <div class="form-group">
                <label>MOTD</label>
                <input type="text" name="motd"
                       value="{{ server_config.get('motd', '') }}"
                       placeholder="Leave empty for vanilla experience">
            </div>
        </div>
    </div>

    <div class="card">
        <button type="submit" class="btn btn-success">Save Configuration</button>
        <span style="color:var(--text-muted); margin-left:15px; font-size:0.875rem;">
            Server restart required for changes to take effect
        </span>
    </div>
</form>

{% if server_type == 'tshock' %}
<div class="card">
    <div class="card-title">TShock Settings (Read Only)</div>
    <p style="color:var(--text-muted); margin-bottom:15px;">
        These settings are from tshock/config.json. Edit the file directly on the server for advanced configuration.
    </p>
    <table class="table">
        <tr>
            <td>REST API</td>
            <td><span class="badge {{ 'badge-success' if tshock_config.get('RESTApiEnabled') else 'badge-danger' }}">
                {{ 'Enabled' if tshock_config.get('RESTApiEnabled') else 'Disabled' }}
            </span></td>
        </tr>
        <tr>
            <td>REST API Port</td>
            <td>{{ tshock_config.get('RESTApiPort', 7878) }}</td>
        </tr>
        <tr>
            <td>Require Login</td>
            <td><span class="badge {{ 'badge-warning' if tshock_config.get('RequireLogin') else 'badge-success' }}">
                {{ 'Yes' if tshock_config.get('RequireLogin') else 'No (Vanilla-like)' }}
            </span></td>
        </tr>
        <tr>
            <td>Spawn Protection</td>
            <td><span class="badge {{ 'badge-warning' if tshock_config.get('SpawnProtection') else 'badge-success' }}">
                {{ 'Yes' if tshock_config.get('SpawnProtection') else 'No (Vanilla-like)' }}
            </span></td>
        </tr>
        <tr>
            <td>Whitelist</td>
            <td><span class="badge {{ 'badge-warning' if tshock_config.get('EnableWhitelist') else 'badge-success' }}">
                {{ 'Enabled' if tshock_config.get('EnableWhitelist') else 'Disabled' }}
            </span></td>
        </tr>
        <tr>
            <td>Auto Save</td>
            <td>{{ 'Every ' + (tshock_config.get('AutoSaveInterval', 10)|string) + ' minutes' if tshock_config.get('AutoSave') else 'Disabled' }}</td>
        </tr>
    </table>
</div>
{% elif server_type == 'tmodloader' %}
<div class="card">
    <div class="card-title">tModLoader Info</div>
    <table class="table">
        <tr>
            <td>Mod management</td>
            <td><a href="{{ url_for('mods.mods') }}" class="btn btn-primary btn-sm">Open Mods Page</a></td>
        </tr>
        <tr>
            <td>Server communication</td>
            <td><span class="badge badge-success">Screen session (stdin commands)</span></td>
        </tr>
        <tr>
            <td>Player requirements</td>
            <td style="color:var(--text-muted);">Players must have tModLoader + same mods installed</td>
        </tr>
        <tr>
            <td>Auto Save</td>
            <td>Built-in tModLoader auto-save</td>
        </tr>
    </table>
</div>
{% endif %}

<div class="card">
    <div class="card-title">Server Version</div>
    <table class="table">
        <tr>
            <td>Server Type</td>
            <td>
                {% if version.server_type == 'tmodloader' %}
                    <span class="badge badge-success">tModLoader</span>
                    <span style="color:var(--text-muted); margin-left:10px;">Terraria 1.4.4.x</span>
                {% elif version.server_type == 'tshock' %}
                    <span class="badge badge-success">TShock</span>
                    <span style="color:var(--text-muted); margin-left:10px;">Terraria 1.4.4.9</span>
                {% else %}
                    <span class="badge badge-warning">Vanilla</span>
                    <span style="color:var(--text-muted); margin-left:10px;">Latest Terraria</span>
                {% endif %}
            </td>
        </tr>
        <tr>
            <td>Current Version</td>
            <td><code>{{ version.current }}</code></td>
        </tr>
        <tr>
            <td>Latest Version</td>
            <td>
                <code>{{ version.latest }}</code>
                {% if version.update_available %}
                    <span class="badge badge-warning" style="margin-left:10px;">Update Available</span>
                {% endif %}
            </td>
        </tr>
    </table>
    <div style="margin-top:15px;" class="btn-group">
        {% if version.server_type == 'tmodloader' %}
        <form method="POST" action="{{ url_for('config_bp.update_tmodloader_route') }}" class="inline-form"
              onsubmit="return confirm('Update tModLoader? Server will restart. Continue?');">
            <button type="submit" class="btn {{ 'btn-warning' if version.update_available else 'btn-primary' }}">
                {{ 'Update tModLoader →' + version.latest if version.update_available else 'Check & Update tModLoader' }}
            </button>
        </form>
        {% else %}
        <form method="POST" action="{{ url_for('config_bp.update_server') }}" class="inline-form"
              onsubmit="return confirm('This will update the server and restart. Continue?');">
            <button type="submit" class="btn {{ 'btn-warning' if version.update_available else 'btn-primary' }}">
                {{ 'Update Now' if version.update_available else 'Force Update' }}
            </button>
        </form>
        {% endif %}
        {% if version.server_type == 'tmodloader' %}
        <a href="https://github.com/tModLoader/tModLoader/releases/latest" target="_blank" rel="noopener"
           class="btn btn-ghost">Changelog ↗</a>
        {% endif %}
    </div>
    <p style="margin-top:15px; color:var(--text-muted); font-size:0.875rem;">
        Switch server type via SSH:
        <code>sudo /opt/terraria/install.sh --tmodloader</code>
        | <code>--tshock</code>
        | <code>--vanilla</code>
    </p>
</div>

<div class="card">
    <div class="card-title">Connection Info</div>
    <p>Players can connect to: <code>your-server-ip:{{ server_config.get('port', '7777') }}</code></p>
</div>

<div class="card">
    <div class="card-title">Discord Notifications</div>
    <p style="color:var(--text-muted); margin-bottom:15px; font-size:0.875rem;">
        Send notifications to a Discord channel via webhook.
        Create a webhook in your Discord server: Channel Settings → Integrations → Webhooks.
    </p>
    <form method="POST" action="{{ url_for('config_bp.discord_config_save') }}">
        <div class="form-group">
            <label>Webhook URL</label>
            <input type="url" name="webhook_url"
                   value="{{ discord_config.get('webhook_url', '') }}"
                   placeholder="https://discord.com/api/webhooks/...">
        </div>
        <div class="grid grid-2" style="margin-bottom:15px;">
            <div>
                <label style="display:flex;align-items:center;gap:8px;margin-bottom:8px;cursor:pointer;">
                    <input type="checkbox" name="notify_start" style="width:auto;" {{ 'checked' if discord_config.get('notify_start', True) }}>
                    Server start
                </label>
                <label style="display:flex;align-items:center;gap:8px;margin-bottom:8px;cursor:pointer;">
                    <input type="checkbox" name="notify_stop" style="width:auto;" {{ 'checked' if discord_config.get('notify_stop', True) }}>
                    Server stop / restart
                </label>
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                    <input type="checkbox" name="notify_backup" style="width:auto;" {{ 'checked' if discord_config.get('notify_backup', False) }}>
                    Backup created
                </label>
            </div>
            <div>
                <label style="display:flex;align-items:center;gap:8px;margin-bottom:8px;cursor:pointer;">
                    <input type="checkbox" name="notify_join" style="width:auto;" {{ 'checked' if discord_config.get('notify_join', True) }}>
                    Player join
                </label>
                <label style="display:flex;align-items:center;gap:8px;margin-bottom:8px;cursor:pointer;">
                    <input type="checkbox" name="notify_leave" style="width:auto;" {{ 'checked' if discord_config.get('notify_leave', True) }}>
                    Player leave
                </label>
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                    <input type="checkbox" name="notify_mod_install" style="width:auto;" {{ 'checked' if discord_config.get('notify_mod_install', False) }}>
                    Mod installed
                </label>
            </div>
        </div>
        <div class="btn-group">
            <button type="submit" class="btn btn-success">Save Discord Settings</button>
        </div>
    </form>
    <form method="POST" action="{{ url_for('config_bp.discord_test') }}" style="margin-top:10px;" class="inline-form">
        <button type="submit" class="btn btn-ghost">Send Test Notification</button>
    </form>
</div>
{% endblock %}
