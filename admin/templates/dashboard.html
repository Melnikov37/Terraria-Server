{% extends "base.html" %}
{% block title %}Dashboard - Terraria Admin{% endblock %}

{% block content %}
<div class="header">
    <h2>Dashboard</h2>
    <div class="btn-group">
        {% if status.online %}
            <form method="POST" action="{{ url_for('server_control', action='restart') }}" class="inline-form">
                <button type="submit" class="btn btn-warning">Restart</button>
            </form>
            <form method="POST" action="{{ url_for('server_control', action='stop') }}" class="inline-form">
                <button type="submit" class="btn btn-danger">Stop Server</button>
            </form>
        {% else %}
            <form method="POST" action="{{ url_for('server_control', action='start') }}" class="inline-form">
                <button type="submit" class="btn btn-success">Start Server</button>
            </form>
        {% endif %}
    </div>
</div>

<div class="card">
    <div class="card-title">Server Status</div>
    <div style="display: flex; align-items: center; margin-bottom: 20px;">
        <span class="status-dot {{ 'online' if status.online else 'offline' }}"></span>
        <span style="font-size: 1.2rem; font-weight: 500;">
            {{ 'Online' if status.online else 'Offline' }}
        </span>
        {% if status.server_type == 'tmodloader' %}
            <span class="badge badge-success" style="margin-left: 15px;">tModLoader</span>
        {% elif status.server_type == 'tshock' %}
            <span class="badge badge-success" style="margin-left: 15px;">TShock</span>
        {% else %}
            <span class="badge badge-warning" style="margin-left: 15px;">Vanilla</span>
        {% endif %}
        {% if status.version %}
            <span class="badge badge-success" style="margin-left: 10px;">{{ status.version }}</span>
        {% endif %}
    </div>

    {% if status.online %}
    <div class="grid grid-4">
        <div class="stat">
            <div class="stat-value">{{ status.players }}</div>
            <div class="stat-label">Players Online</div>
        </div>
        <div class="stat">
            <div class="stat-value">{{ status.max_players }}</div>
            <div class="stat-label">Max Players</div>
        </div>
        <div class="stat">
            <div class="stat-value">{{ status.port }}</div>
            <div class="stat-label">Port</div>
        </div>
        <div class="stat">
            <div class="stat-value" style="font-size: 1rem;">{{ status.world }}</div>
            <div class="stat-label">World</div>
        </div>
    </div>
    {% else %}
    <p style="color: var(--text-muted);">
        {% if status.service and status.server_type == 'tmodloader' %}
            Service is running but screen session not detected. Server might still be loading the world...
        {% elif status.service %}
            Service is running but REST API is not responding. Server might be starting up...
        {% else %}
            Server is stopped. Click "Start Server" to begin.
        {% endif %}
    </p>
    {% endif %}
</div>

<!-- Resource metrics -->
<div class="card" id="metricsCard" style="display:none;">
    <div class="card-title">System Resources</div>
    <div class="grid grid-4" id="metricsGrid"></div>
</div>

<!-- Online players (auto-refreshed) -->
<div class="card" id="playersCard">
    <div class="card-title">Online Players <span id="playerCount" style="color:var(--text-muted);"></span></div>
    <div id="playersList">
        {% if status.online and players %}
        <table class="table">
            <thead><tr><th>Name</th><th>Actions</th></tr></thead>
            <tbody>
                {% for player in players %}
                <tr>
                    <td>{{ player.nickname }}</td>
                    <td>
                        <form method="POST" action="{{ url_for('kick_player') }}" class="inline-form">
                            <input type="hidden" name="player" value="{{ player.nickname }}">
                            <button type="submit" class="btn btn-danger btn-sm">Kick</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% elif status.online %}
        <p style="color: var(--text-muted);">No players online</p>
        {% else %}
        <p style="color: var(--text-muted);">Server is offline</p>
        {% endif %}
    </div>
</div>

<div class="card">
    <div class="card-title">Quick Actions</div>
    <div class="btn-group">
        <form method="POST" action="{{ url_for('save_world') }}" class="inline-form">
            <button type="submit" class="btn btn-primary" {{ 'disabled' if not status.online }}>Save World</button>
        </form>
        <a href="{{ url_for('world') }}" class="btn btn-primary">World Controls</a>
        {% if status.server_type == 'tmodloader' %}
        <a href="{{ url_for('mods') }}" class="btn btn-primary">Manage Mods</a>
        {% endif %}
        <a href="{{ url_for('backups') }}" class="btn btn-primary">Backups</a>
        <a href="{{ url_for('logs') }}" class="btn btn-primary">Logs</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function updatePlayers() {
    fetch('/api/players')
        .then(r => r.json())
        .then(players => {
            const count = document.getElementById('playerCount');
            count.textContent = `(${players.length})`;
            const list = document.getElementById('playersList');
            if (!players.length) {
                list.innerHTML = '<p style="color:var(--text-muted)">No players online</p>';
                return;
            }
            let rows = players.map(p =>
                `<tr><td>${p.nickname || p.name || ''}</td><td>
                 <form method="POST" action="/players/kick" class="inline-form">
                   <input type="hidden" name="player" value="${p.nickname || p.name || ''}">
                   <button class="btn btn-danger btn-sm">Kick</button>
                 </form></td></tr>`
            ).join('');
            list.innerHTML = `<table class="table"><thead><tr><th>Name</th><th>Actions</th></tr></thead><tbody>${rows}</tbody></table>`;
        })
        .catch(() => {});
}

function updateMetrics() {
    fetch('/api/metrics')
        .then(r => r.json())
        .then(m => {
            if (m.error) return;
            const card = document.getElementById('metricsCard');
            card.style.display = '';
            const grid = document.getElementById('metricsGrid');
            const items = [
                { v: m.cpu_percent + '%', l: 'CPU' },
                { v: `${m.ram_used_gb}/${m.ram_total_gb} GB`, l: `RAM ${m.ram_percent}%` },
                { v: m.disk_used_gb != null ? `${m.disk_used_gb}/${m.disk_total_gb} GB` : '—', l: 'Disk' },
                { v: m.server_ram_mb != null ? m.server_ram_mb + ' MB' : '—', l: 'Server RAM' },
            ];
            grid.innerHTML = items.map(i =>
                `<div class="stat"><div class="stat-value" style="font-size:1.4rem">${i.v}</div><div class="stat-label">${i.l}</div></div>`
            ).join('');
        })
        .catch(() => {});
}

function updateStatus() {
    fetch('/api/status')
        .then(r => r.json())
        .then(data => {
            const dot = document.querySelector('.status-dot');
            dot.classList.toggle('online', !!data.online);
            dot.classList.toggle('offline', !data.online);
        })
        .catch(() => {});
}

updateMetrics();
updatePlayers();
setInterval(updateStatus, 15000);
setInterval(updatePlayers, 10000);
setInterval(updateMetrics, 8000);
</script>
{% endblock %}
