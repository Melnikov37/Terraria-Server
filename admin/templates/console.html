{% extends "base.html" %}
{% block title %}Console â€” Terraria Admin{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Live Console</h2>
    <div class="btn-group">
        <button id="btnFollow" class="btn btn-success" onclick="toggleFollow()">Follow ON</button>
        <button class="btn btn-ghost" onclick="clearDisplay()">Clear</button>
    </div>
</div>

<div class="card" style="padding:0;">
    <div id="output" style="
        font-family:var(--font-mono);
        font-size:0.82rem;
        line-height:1.5;
        height:520px;
        overflow-y:auto;
        padding:16px;
        background:var(--bg);
        border-radius:var(--radius-md);
        white-space:pre-wrap;
        word-break:break-all;
    "></div>
</div>

<div class="card">
    <div class="card-title">Send Command</div>
    <div style="display:flex; gap:10px;">
        <input type="text" id="cmdInput" placeholder="e.g. players, save, dawn, say Hello" style="flex:1;"
               onkeydown="if(event.key==='Enter') sendCmd()">
        <button class="btn btn-primary" onclick="sendCmd()" style="height:42px;">Send</button>
    </div>
    <small style="color:var(--text-muted); display:block; margin-top:8px;">
        Commands are sent to the server via screen stdin.
        Available: dawn, noon, dusk, midnight, save, players, say &lt;msg&gt;, kick &lt;name&gt;, ban &lt;name&gt;, exit
    </small>
</div>
{% endblock %}

{% block scripts %}
<script>
const output = document.getElementById('output');
let cursor = 0;
let following = true;

function colorLine(line) {
    const lo = line.toLowerCase();
    if (lo.includes('error') || lo.includes('exception') || lo.includes('fatal') || lo.includes('fail')) {
        return `<span style="color:var(--danger)">${escHtml(line)}</span>`;
    }
    if (lo.includes('warn')) {
        return `<span style="color:var(--warning)">${escHtml(line)}</span>`;
    }
    if (lo.includes('has joined') || lo.includes('joined the game')) {
        return `<span style="color:var(--success)">${escHtml(line)}</span>`;
    }
    if (lo.includes('has left') || lo.includes('disconnected')) {
        return `<span style="color:var(--text-muted)">${escHtml(line)}</span>`;
    }
    return escHtml(line);
}

function escHtml(s) {
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function appendLines(lines) {
    output.innerHTML += lines.map(l => colorLine(l)).join('\n') + '\n';
    if (following) output.scrollTop = output.scrollHeight;
}

function poll() {
    fetch(`/api/console/lines?since=${cursor}`)
        .then(r => r.json())
        .then(data => {
            if (data.lines && data.lines.length > 0) {
                appendLines(data.lines);
                cursor = data.total;
            }
        })
        .catch(() => {});
}

function toggleFollow() {
    following = !following;
    const btn = document.getElementById('btnFollow');
    btn.textContent = following ? 'Follow ON' : 'Follow OFF';
    btn.className = following ? 'btn btn-success' : 'btn btn-ghost';
    if (following) output.scrollTop = output.scrollHeight;
}

function clearDisplay() {
    output.innerHTML = '';
}

function sendCmd() {
    const input = document.getElementById('cmdInput');
    const cmd = input.value.trim();
    if (!cmd) return;
    input.value = '';
    fetch('/api/console/send', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({cmd})
    })
    .then(r => r.json())
    .then(data => {
        if (!data.ok) {
            output.innerHTML += `<span style="color:var(--danger)">[error] ${escHtml(data.error || 'Send failed')}</span>\n`;
        } else {
            output.innerHTML += `<span style="color:var(--accent)">&gt; ${escHtml(cmd)}</span>\n`;
            if (following) output.scrollTop = output.scrollHeight;
        }
    })
    .catch(() => {});
}

poll();
setInterval(poll, 2000);
</script>
{% endblock %}
