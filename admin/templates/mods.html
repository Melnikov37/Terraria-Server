{% extends "base.html" %}
{% block title %}Mods — Terraria Admin{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Mods Management</h2>
    <div class="btn-group">
        {% if mods %}
        <form method="POST" action="{{ url_for('mods.mods_update_all') }}" class="inline-form">
            <button type="submit" class="btn btn-primary"
                    onclick="return confirm('Update all mods from Steam Workshop? This may take several minutes.');">
                Update All
            </button>
        </form>
        {% endif %}
        <a href="{{ url_for('mods.mods_search') }}" class="btn btn-ghost">Popular Mods</a>
    </div>
</div>

{% if server_type != 'tmodloader' %}
<div class="card" style="border-color:var(--warning);">
    <p style="color:var(--warning);">
        Mod management is only available for <strong>tModLoader</strong> servers.
        Current server type: <strong>{{ server_type|upper }}</strong>
    </p>
    <p style="color:var(--text-muted); margin-top:10px;">
        Re-install with <code>sudo ./install.sh --tmodloader</code> to switch.
    </p>
</div>
{% else %}

<div class="card">
    <div class="card-title">Install from Steam Workshop</div>
    <p style="color:var(--text-muted); margin-bottom:15px;">
        Paste a <strong>Workshop ID</strong> — the server downloads the mod automatically via steamcmd.
        Find the ID in the Workshop URL: <code>steamcommunity.com/sharedfiles/filedetails/?id=<strong>2824688072</strong></code>
    </p>
    <form method="POST" action="{{ url_for('mods.mods_workshop') }}">
        <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;">
            <div class="form-group" style="flex:1; min-width:200px; margin-bottom:0;">
                <label>Workshop ID</label>
                <input type="text" name="workshop_id" placeholder="e.g. 2824688072" pattern="\d+" required>
            </div>
            <button type="submit" class="btn btn-success" style="height:42px;">Download &amp; Install</button>
            <a href="{{ url_for('mods.mods_search') }}" class="btn btn-ghost" style="height:42px; line-height:26px;">Popular mods list</a>
        </div>
    </form>
</div>

<div class="card">
    <div class="card-title">Upload .tmod file manually</div>
    <form method="POST" action="{{ url_for('mods.mods_upload') }}" enctype="multipart/form-data" id="upload-form">
        <label id="drop-zone" for="mod_file_input" style="
            display:flex; flex-direction:column; align-items:center; justify-content:center;
            gap:10px; padding:28px 20px; border:2px dashed var(--border);
            border-radius:var(--radius-md); cursor:pointer; transition:var(--transition);
            background:var(--bg-input); text-align:center; user-select:none;">
            <svg width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="var(--text-muted)" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round"
                      d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5"/>
            </svg>
            <span id="drop-label" style="color:var(--text-muted); font-size:0.9rem;">
                Drag &amp; drop a <code>.tmod</code> file here, or click to browse
            </span>
        </label>
        <input type="file" name="mod_file" id="mod_file_input" accept=".tmod" required style="display:none;">
        <div style="display:flex; justify-content:flex-end; margin-top:12px;">
            <button type="submit" class="btn btn-success">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" width="16" height="16">
                    <path stroke-linecap="round" stroke-linejoin="round"
                          d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12M12 16.5V3"/>
                </svg>
                Upload &amp; Enable
            </button>
        </div>
    </form>
</div>

{% block scripts %}{{ super() if super is defined }}
<script>
(function() {
    var zone = document.getElementById('drop-zone');
    var input = document.getElementById('mod_file_input');
    var label = document.getElementById('drop-label');

    input.addEventListener('change', function() {
        if (input.files.length) {
            label.textContent = input.files[0].name;
            label.style.color = 'var(--text)';
            zone.style.borderColor = 'var(--accent)';
        }
    });

    ['dragover', 'dragenter'].forEach(function(evt) {
        zone.addEventListener(evt, function(e) {
            e.preventDefault();
            zone.style.borderColor = 'var(--accent)';
            zone.style.background = 'var(--accent-glow)';
        });
    });

    ['dragleave', 'dragend'].forEach(function(evt) {
        zone.addEventListener(evt, function() {
            zone.style.borderColor = 'var(--border)';
            zone.style.background = 'var(--bg-input)';
        });
    });

    zone.addEventListener('drop', function(e) {
        e.preventDefault();
        zone.style.borderColor = 'var(--border)';
        zone.style.background = 'var(--bg-input)';
        var file = e.dataTransfer.files[0];
        if (!file) return;
        if (!file.name.endsWith('.tmod')) {
            label.textContent = 'Only .tmod files are allowed';
            label.style.color = 'var(--danger)';
            zone.style.borderColor = 'var(--danger)';
            return;
        }
        var dt = new DataTransfer();
        dt.items.add(file);
        input.files = dt.files;
        label.textContent = file.name;
        label.style.color = 'var(--text)';
        zone.style.borderColor = 'var(--accent)';
    });
})();
</script>
{% endblock %}

<div class="card">
    <div class="card-title">
        Installed Mods ({{ mods|length }})
        {% if mods %}
        <span style="color:var(--text-muted); font-size:0.8rem; margin-left:10px; text-transform:none; letter-spacing:0; font-weight:400;">
            — restart server to apply changes
        </span>
        {% endif %}
    </div>

    {% if not mods %}
    <p style="color:var(--text-muted);">
        No mods installed. Upload a <code>.tmod</code> file or search the catalog above.
    </p>
    <p style="color:var(--text-muted); margin-top:8px; font-size:0.875rem;">
        Mods directory: <code>{{ mods_dir }}</code>
    </p>
    {% else %}
    <table class="table">
        <thead>
            <tr>
                <th>Mod Name</th>
                <th>Version</th>
                <th>Size</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for mod in mods %}
            <tr>
                <td>
                    <strong>{{ mod.name }}</strong>
                    {% if mod.workshop_id %}
                    <br><span style="color:var(--text-muted); font-size:0.78rem;">
                        Workshop: {{ mod.workshop_id }}
                    </span>
                    {% endif %}
                </td>
                <td style="font-size:0.875rem;">
                    <code>{{ mod.version }}</code>
                    {% if mod.last_updated %}
                    <br><span style="color:var(--text-muted); font-size:0.78rem;" title="{{ mod.last_updated }}">
                        updated {{ mod.last_updated[:10] }}
                    </span>
                    {% endif %}
                </td>
                <td style="color:var(--text-muted); font-size:0.875rem;">
                    {{ mod.size_mb }} MB
                </td>
                <td>
                    {% if mod.enabled %}
                        <span class="badge badge-success">Enabled</span>
                    {% else %}
                        <span class="badge badge-danger">Disabled</span>
                    {% endif %}
                </td>
                <td>
                    <div class="btn-group">
                        <form method="POST" action="{{ url_for('mods.mods_toggle') }}" class="inline-form">
                            <input type="hidden" name="mod_name" value="{{ mod.name }}">
                            <button type="submit" class="btn btn-sm {{ 'btn-warning' if mod.enabled else 'btn-success' }}">
                                {{ 'Disable' if mod.enabled else 'Enable' }}
                            </button>
                        </form>
                        {% if mod.workshop_id %}
                        <form method="POST" action="{{ url_for('mods.mods_update_one') }}" class="inline-form">
                            <input type="hidden" name="mod_name" value="{{ mod.name }}">
                            <button type="submit" class="btn btn-primary btn-sm">Update</button>
                        </form>
                        {% endif %}
                        <form method="POST" action="{{ url_for('mods.mods_delete') }}" class="inline-form"
                              onsubmit="return confirm('Delete mod {{ mod.name|e }}? This cannot be undone.');">
                            <input type="hidden" name="mod_name" value="{{ mod.name }}">
                            <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}
</div>

<div class="card" style="border-color:var(--warning);">
    <div class="card-title" style="color:var(--warning);">Important: Client Requirements</div>
    <p style="color:var(--text-muted);">
        All players must install the same mods in their <strong>tModLoader client</strong> before joining.
        Players without matching mods will be rejected when connecting.
    </p>
    <p style="color:var(--text-muted); margin-top:8px;">
        How players install mods: open <strong>tModLoader</strong> → Mod Browser → search mod name → Install → Enable → join server.
    </p>
</div>

{% endif %}
{% endblock %}
