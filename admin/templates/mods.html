{% extends "base.html" %}
{% block title %}Mods — Terraria Admin{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Mods Management</h2>
    <div class="btn-group">
        {% if mods %}
        <form method="POST" action="{{ url_for('mods.mods_update_all') }}" class="inline-form">
            <button type="submit" class="btn btn-primary"
                    onclick="return confirm('Update all mods from Steam Workshop? This may take several minutes.');">
                Update All
            </button>
        </form>
        {% endif %}
        <a href="{{ url_for('mods.mods_search') }}" class="btn btn-ghost">Popular Mods</a>
    </div>
</div>

{% if server_type != 'tmodloader' %}
<div class="card" style="border-color:var(--warning);">
    <p style="color:var(--warning);">
        Mod management is only available for <strong>tModLoader</strong> servers.
        Current server type: <strong>{{ server_type|upper }}</strong>
    </p>
    <p style="color:var(--text-muted); margin-top:10px;">
        Re-install with <code>sudo ./install.sh --tmodloader</code> to switch.
    </p>
</div>
{% else %}

<div class="card">
    <div class="card-title">Install from Steam Workshop</div>
    <p style="color:var(--text-muted); margin-bottom:15px;">
        Paste a <strong>Workshop ID</strong> — the server downloads the mod automatically via steamcmd.
        Find the ID in the Workshop URL: <code>steamcommunity.com/sharedfiles/filedetails/?id=<strong>2824688072</strong></code>
    </p>
    <form method="POST" action="{{ url_for('mods.mods_workshop') }}">
        <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;">
            <div class="form-group" style="flex:1; min-width:200px; margin-bottom:0;">
                <label>Workshop ID</label>
                <input type="text" name="workshop_id" placeholder="e.g. 2824688072" pattern="\d+" required>
            </div>
            <button type="submit" class="btn btn-success" style="height:42px;">Download &amp; Install</button>
            <a href="{{ url_for('mods.mods_search') }}" class="btn btn-ghost" style="height:42px; line-height:26px;">Popular mods list</a>
        </div>
    </form>
</div>

<div class="card">
    <div class="card-title">Upload .tmod file manually</div>
    <form method="POST" action="{{ url_for('mods.mods_upload') }}" enctype="multipart/form-data">
        <div style="display:flex; gap:10px; align-items:flex-end;">
            <div class="form-group" style="flex:1; margin-bottom:0;">
                <input type="file" name="mod_file" accept=".tmod" required style="padding:8px; cursor:pointer;">
            </div>
            <button type="submit" class="btn btn-success" style="height:42px;">Upload &amp; Enable</button>
        </div>
    </form>
</div>

<div class="card">
    <div class="card-title">
        Installed Mods ({{ mods|length }})
        {% if mods %}
        <span style="color:var(--text-muted); font-size:0.8rem; margin-left:10px; text-transform:none; letter-spacing:0; font-weight:400;">
            — restart server to apply changes
        </span>
        {% endif %}
    </div>

    {% if not mods %}
    <p style="color:var(--text-muted);">
        No mods installed. Upload a <code>.tmod</code> file or search the catalog above.
    </p>
    <p style="color:var(--text-muted); margin-top:8px; font-size:0.875rem;">
        Mods directory: <code>{{ mods_dir }}</code>
    </p>
    {% else %}
    <table class="table">
        <thead>
            <tr>
                <th>Mod Name</th>
                <th>Version</th>
                <th>Size</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for mod in mods %}
            <tr>
                <td>
                    <strong>{{ mod.name }}</strong>
                    {% if mod.workshop_id %}
                    <br><span style="color:var(--text-muted); font-size:0.78rem;">
                        Workshop: {{ mod.workshop_id }}
                    </span>
                    {% endif %}
                </td>
                <td style="font-size:0.875rem;">
                    <code>{{ mod.version }}</code>
                    {% if mod.last_updated %}
                    <br><span style="color:var(--text-muted); font-size:0.78rem;" title="{{ mod.last_updated }}">
                        updated {{ mod.last_updated[:10] }}
                    </span>
                    {% endif %}
                </td>
                <td style="color:var(--text-muted); font-size:0.875rem;">
                    {{ mod.size_mb }} MB
                </td>
                <td>
                    {% if mod.enabled %}
                        <span class="badge badge-success">Enabled</span>
                    {% else %}
                        <span class="badge badge-danger">Disabled</span>
                    {% endif %}
                </td>
                <td>
                    <div class="btn-group">
                        <form method="POST" action="{{ url_for('mods.mods_toggle') }}" class="inline-form">
                            <input type="hidden" name="mod_name" value="{{ mod.name }}">
                            <button type="submit" class="btn btn-sm {{ 'btn-warning' if mod.enabled else 'btn-success' }}">
                                {{ 'Disable' if mod.enabled else 'Enable' }}
                            </button>
                        </form>
                        {% if mod.workshop_id %}
                        <form method="POST" action="{{ url_for('mods.mods_update_one') }}" class="inline-form">
                            <input type="hidden" name="mod_name" value="{{ mod.name }}">
                            <button type="submit" class="btn btn-primary btn-sm">Update</button>
                        </form>
                        {% endif %}
                        <form method="POST" action="{{ url_for('mods.mods_delete') }}" class="inline-form"
                              onsubmit="return confirm('Delete mod {{ mod.name|e }}? This cannot be undone.');">
                            <input type="hidden" name="mod_name" value="{{ mod.name }}">
                            <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}
</div>

<div class="card" style="border-color:var(--warning);">
    <div class="card-title" style="color:var(--warning);">Important: Client Requirements</div>
    <p style="color:var(--text-muted);">
        All players must install the same mods in their <strong>tModLoader client</strong> before joining.
        Players without matching mods will be rejected when connecting.
    </p>
    <p style="color:var(--text-muted); margin-top:8px;">
        How players install mods: open <strong>tModLoader</strong> → Mod Browser → search mod name → Install → Enable → join server.
    </p>
</div>

{% endif %}
{% endblock %}
