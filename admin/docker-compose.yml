services:
  terraria-server:
    image: ${DOCKERHUB_USERNAME:-melnikov37}/terraria-server:${IMAGE_TAG:-latest}
    container_name: terraria-server
    restart: unless-stopped
    # tty: true gives the container a pseudo-TTY.
    # Without it, .NET's Console.Out is block-buffered (4 KB) when stdout is a pipe,
    # so Docker logs stay empty until the buffer fills. With a TTY, .NET switches to
    # line-buffered mode and every log line appears in Docker logs immediately.
    tty: true
    ports:
      - "7777:7777/tcp"
      - "7777:7777/udp"
    volumes:
      - /opt/terraria:/opt/terraria
    environment:
      - TERRARIA_DIR=/opt/terraria
      - PORT=${SERVER_PORT:-7777}
      - MAX_PLAYERS=${MAX_PLAYERS:-8}
      - WORLD_NAME=${WORLD_NAME:-TerrariaWorld}
      - DIFFICULTY=${DIFFICULTY:-0}
      - AUTOCREATE=${AUTOCREATE:-2}
      - SERVER_PASSWORD=${SERVER_PASSWORD:-}
    stop_grace_period: 30s

  terraria-admin:
    image: ${DOCKERHUB_USERNAME:-melnikov37}/terraria-admin:${IMAGE_TAG:-latest}
    container_name: terraria-admin
    restart: unless-stopped
    depends_on:
      - terraria-server
    ports:
      - "5000:5000"
    pid: host                        # allows psutil to see host processes for system metrics
    volumes:
      - /opt/terraria:/opt/terraria
      - /var/run/docker.sock:/var/run/docker.sock   # Docker SDK control
    environment:
      - SECRET_KEY=${SECRET_KEY}
      - ADMIN_TOKEN=${ADMIN_TOKEN}
      - TERRARIA_DIR=/opt/terraria
      - SERVER_CONTAINER=terraria-server
      - SERVER_TYPE=${SERVER_TYPE:-tmodloader}
      - MODS_DIR=${MODS_DIR:-/opt/terraria/tModLoader/Mods}
      - DISCORD_CONFIG=${DISCORD_CONFIG:-/opt/terraria/discord.json}
      # LOG_FILE intentionally omitted: tModLoader writes to stdout (Docker logs),
      # not a file. The console poller fills the in-memory buffer from Docker logs,
      # and /api/logs falls back to that buffer.
    user: "0:0"
