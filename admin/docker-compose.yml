services:
  terraria-server:
    image: ${DOCKERHUB_USERNAME:-melnikov37}/terraria-server:${IMAGE_TAG:-latest}
    container_name: terraria-server
    restart: unless-stopped
    # tty: true gives the container a pseudo-TTY.
    # Without it, .NET's Console.Out is block-buffered (4 KB) when stdout is a pipe,
    # so Docker logs stay empty until the buffer fills. With a TTY, .NET switches to
    # line-buffered mode and every log line appears in Docker logs immediately.
    tty: true
    ports:
      - "7777:7777/tcp"
      - "7777:7777/udp"
    volumes:
      - /opt/terraria:/opt/terraria
      # Mount tModLoader's log directory into the shared volume so the admin
      # panel can read server.log directly.
      # tModLoader (server mode) writes logs to /server/tModLoader-Logs/ â€” NOT to
      # /root/.local/share/Terraria/tModLoader/Logs/ which is used only by the client.
      - /opt/terraria/logs:/server/tModLoader-Logs
    environment:
      - TERRARIA_DIR=/opt/terraria
      - PORT=${SERVER_PORT:-7777}
      - MAX_PLAYERS=${MAX_PLAYERS:-8}
      - WORLD_NAME=${WORLD_NAME:-TerrariaWorld}
      - DIFFICULTY=${DIFFICULTY:-0}
      - AUTOCREATE=${AUTOCREATE:-2}
      - SERVER_PASSWORD=${SERVER_PASSWORD:-}
    stop_grace_period: 30s

  terraria-admin:
    image: ${DOCKERHUB_USERNAME:-melnikov37}/terraria-admin:${IMAGE_TAG:-latest}
    container_name: terraria-admin
    restart: unless-stopped
    depends_on:
      - terraria-server
    ports:
      - "5000:5000"
    pid: host                        # allows psutil to see host processes for system metrics
    volumes:
      - /opt/terraria:/opt/terraria
      - /var/run/docker.sock:/var/run/docker.sock   # Docker SDK control
    environment:
      - SECRET_KEY=${SECRET_KEY}
      - ADMIN_TOKEN=${ADMIN_TOKEN}
      - TERRARIA_DIR=/opt/terraria
      - SERVER_CONTAINER=terraria-server
      - SERVER_TYPE=${SERVER_TYPE:-tmodloader}
      - MODS_DIR=${MODS_DIR:-/opt/terraria/tModLoader/Mods}
      - DISCORD_CONFIG=${DISCORD_CONFIG:-/opt/terraria/discord.json}
      # tModLoader (server mode) writes logs to /server/tModLoader-Logs/server.log
      # inside the server container. That directory is mounted at /opt/terraria/logs
      # on the host (and accessible to this container via the /opt/terraria volume).
      - LOG_FILE=/opt/terraria/logs/server.log
    user: "0:0"
